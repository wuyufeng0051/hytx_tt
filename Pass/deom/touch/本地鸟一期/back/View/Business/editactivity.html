<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>我的发布</title>
    <link rel="stylesheet" href="__PUBLIC__/Home/css/re_public.css">
    <link rel="stylesheet" href="__PUBLIC__/Home/css/_head.css">
    <script type="text/javascript" src="__PUBLIC__/Home/js/zepto.min.js"></script>
    <script type="text/javascript" src="__PUBLIC__/Home/js/touchScale.js"></script>
</head>
<body>
    <style>
        body{
            margin-top: 0;
        }
        .header {
            height: .9rem;
            background: #fd5530 !important;
            color: #fff;
            font-size: .32rem;
            line-height: .9rem;
            max-width: 1080px;
            position: relative;
            left: 0;
            right: 0;
            top: 0;
            z-index: 11;
            overflow: hidden;
        }
    </style>
<include file="Public/share" title='包含文件'/>
<!-- 共同顶部 s-->
<div class="header fn-clear">
    <div class="back"><a href="javascript:history.go(-1)"><i></i>返回</a></div>
    <div class="title">编辑活动内容</div>
</div>
<!-- 共同顶部 e-->

<link rel="stylesheet" type="text/css" href="__PUBLIC__/Home/css/mobiscroll.css" />
<link rel="stylesheet" href="__PUBLIC__/Home/css/enter.css">
<script type="text/javascript" src="__PUBLIC__/Home/js/mobiscroll.js"></script>

<input type="hidden" value="{$Think.get.activity_id}" id="activity_id">
<div class="write fn-clear">
    <span><i></i>活动主题</span><input type="text" placeholder="请输活动主题 20字以内" id="activity_title" value="{$activity_edit['activity_title']}">
</div>
<div class="tel_box" style="border-bottom: 0.02rem solid #e6e6e6;">
    <span><i></i>活动时间</span>
    <div class="tel_list" >
        <div class="phone_num">
            <input id="EndTime" runat="server" placeholder="开始时间"  readonly="readonly" value="{$activity_edit['activity_start']|substr=0,10}"/>
        </div>
        <input id="EndDate" runat="server"  readonly="readonly"  placeholder="结束时间" value="{$activity_edit['activity_end']|substr=0,10}"/>
    </div>
</div>
<div class="intro">
    <h1><em></em>活动内容</h1>
    <div class="intro_txt">
        <textarea name="" id="activity_content" cols="30" rows="10" placeholder="请输入您的活动详细内容… 500字以内">{$activity_edit['activity_content']}</textarea>
    </div>
</div>
<div class="certfy picture_2" style="margin-bottom: 1rem">
    <div class="pic_list">
        <div class="img-box">
            <ul class="uploader-list fn-clear" id="fileList2">
                <foreach name="activity_edit['imgs']" item="shopimgs">
                    <li><img src="{$shopimgs['imgs_smallpath']}" data-imgid="{$shopimgs['imgs_id']}"/><i></i></li>
                </foreach>
                <li class="uploadbtn">
                    <div id="filePicker2" data-type="atlas" data-amount="9" class="webuploader-container picker">
                        <div class="webuploader-pick"><div class="webuploader-pick"><em></em><p>活动相册</p></div></div>
                    </div>
                </li>
            </ul>
            <p class="imgtip"></p>
            <div class="pic_tips">（活动相册628X366长方形图片最佳，最多可上传9张） </div>
        </div>
    </div>
</div>
<div class="disk"> </div>
<div class="delete">
    <h1>提示：</h1>
    <h2>是否删除？</h2>
    <div class="de_foot"><div class="de_btn"><span class="sure">确定</span><span class="cancel">取消</span></div></div>
</div>
 <!--修改成功 s-->
<div class="succeed_box cheng">
<h1>修改成功</h1>
<h2>您可以在<em>个人中心-我的发布</em>进行管理</h2>
<p><a href="javascript:history.go(-1);location.replace(document.referrer);"><span>确定</span></a></p>
</div>
 <!--修改成功 e-->
<div class="btn" style="position: fixed;bottom: 0;left: 0;right: 0;">确定修改</div>
<script type="text/javascript" src="__PUBLIC__/Home/js/mobiscroll.datetime.js"></script>
<script type="text/javascript" src="__PUBLIC__/Home/js/mobiscroll.select.js"></script>
<script type="text/javascript" src="__PUBLIC__/Home/js/huodong.js?v=3"></script>
<script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
<script src="__PUBLIC__/Home/js/layer.js"></script>
<script>
    // 调用微信接口上传图片
    wx.config({
        debug: false,
        appId: '<?php echo $signPackage["appId"];?>',
        timestamp: '<?php echo $signPackage['timestamp'];?>',
        nonceStr: '<?php echo $signPackage['nonceStr'];?>',
        signature: '<?php echo $signPackage['signature'];?>',
        jsApiList: [
            // 所有要调用的 API 都要加到这个列表中
            'chooseImage',
            'uploadImage',
            'downloadImage'
        ]
    });
    var download_img=[];
    var images = {
        localId: [],
        serverId: []
    }
    $("#filePicker2").click(function(){
        var length = $('#fileList2 li').length;
        var conunt = 10 - length;
        if (conunt == 0) {

        }else{
            wx.ready(function(){
                //拍照或从手机相册中选图接口
                wx.chooseImage({
                    count: conunt, // 最多能选择多少张图片，默认9
                    sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
                    sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
                    success: function (res) {
                        var localId = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
                        var localIdImg=localId.toString().split(",");
                        //上传图片接口
                        if (localIdImg.length == 0) {
                            return;
                        }
                        var i = 0, length = images.localId.length;
                        images.serverId = [];
                        function upload() {
                            wx.uploadImage({
                                localId: localIdImg[i],
                                success: function (res) {
                                    $("#fileList2").prepend('<li><img src="'+localIdImg[i]+'" /><i></i></li>');
                                    i++;
                                    images.serverId.push(res.serverId);
                                    download_img =images.serverId;
                                    if (i < localIdImg.length) {
                                        upload();
                                    }
                                    if ($('.picture_2 ul li').length > 8) {
                                        var x = $('.picture_2 ul li');
                                        x.closest('.uploader-list').find('.uploadbtn').hide();
                                    }
                                },
                                fail: function (res) {
                                    alert(JSON.stringify(res));
                                }
                            });
                        }
                        upload();
                    }
                });
            });
        }
    });
    $('.picture_2').delegate('#fileList2 li i','click',function(){
        var x = $(this),
            id = x.closest('li').find('img').data('imgid');
        $('.delete').show();
        $('.disk').show();
        $('.delete .sure').click(function(){
            if(id=='') {
                find = x.closest('li');
                find.remove();
                if ($('.picture_2 ul li').length < 10) {
                    $('.picture_2').find('.uploadbtn').show();
                }
                $('.delete').hide();
                $('.disk').hide();
            }else{
                $.post("__MODULE__/Business/delimg",{imgs_id:id},function(data) {
                    if (data.status == "1") {
                        find = x.closest('li');
                        find.remove();
                        if ($('.picture_2 ul li').length < 10) {
                            $('.picture_2').find('.uploadbtn').show();
                        }
                        $('.delete').hide();
                        $('.disk').hide();
                    }else{
                        $('.delete').hide();
                        $('.disk').hide();
                    }
                })
            }
        })
    })
    $('.btn').click(function(){
        $.post('{:U("Home/Index/userRelease")}', {}, function(data) {
            if (data == 1) {
                layer.msg('对不起，您没有权利发布信息')
            }else{
                var bianhu = 0;
                var activity_termid = $('#activity_termid').val();
                var activity_title = $('#activity_title').val();
                var activity_start = $('#EndTime').val();
                var activity_end = $('#EndDate').val();
                var activity_imgs= $('#fileList2 li').length;
                var activity_content=$('#activity_content').val();
                var activity_id=$('#activity_id').val();
                if (!activity_title) {
                    layer.msg('请先填写活动主题')
                }else if(!activity_start){
                    layer.msg('请先选择活动时间')
                }else if(!activity_end){
                    layer.msg('请先选择活动时间')
                }else if(!activity_content){
                    layer.msg('请先填写活动内容')
                } else{
                    bianhu = 1;
                }
                if (bianhu == 1) {
                    //加载层
                    var index = layer.load(0, {shade: [0.5,'#000']}); //0代表加载的风格，支持0-2
                    $.post("__MODULE__/Business/editactivity",{activity_id:activity_id,activity_termid:activity_termid,activity_title:activity_title,activity_start:activity_start,activity_end:activity_end,activity_imgs:download_img,activity_content:activity_content},function(data) {
                        if (data.status == "1") {
                            layer.close(index);
                            //提交成功弹出层
                            $('.cheng').show();
                            $('.disk').show();
                        }else{
                            alert(data.msg);
                        }
                    })
                }

            }
        })
    })
</script>
</body>
</html>